kind: DaemonSet
apiVersion: extensions/v1beta1
metadata:
  name: kubelet-controller
  namespace: kube-system
  labels:
    app: kubelet
    role: controller
spec:
  template:
    metadata:
      labels:
        app: kubelet
        role: controller
    spec:
      nodeSelector:
        role: controller
      hostPID: true
      hostNetwork: true
      containers:
        - name: vault-certs
          image: quay.io/roboll/vault-cert-sidecar:v0.0.1-6-g0c646b8
          command:
            - /bin/sh
            - -c
            - /vault-cert-sidecar
              -auth-strategy=token-file
              -pki-backend=${KUBE_PKI_MOUNT}
              -auth-dir=/var/lib/vault/
              -cert-dir=/etc/kubelet/
              -hostname=kubelet
              -san=$(hostname -f)
          env:
            - name: VAULT_ADDR
              value: ${VAULT_ADDR}
          volumeMounts:
            - name: etc-kubelet
              mountPath: /etc/kubelet/
            - name: var-lib-vault
              mountPath: /var/lib/vault/
#        - name: socat-bin
#          image: alpine:3.4
#          command:
#            - /bin/sh
#            - -c
#            - apk add --update curl;
#              curl -L https://github.com/andrew-d/static-binaries/raw/master/binaries/linux/x86_64/socat -o /opt/bin/socat;
#              chmod +x /opt/bin/socat;
#              while true; do sleep 3600; done;
#          volumeMounts:
#            - name: opt-bin
#              mountPath: /opt/bin/
#        - name: cni-bin
#          image: ${HYPERKUBE}
#          command:
#            - /bin/sh
#            - -c
#            - cp -r /opt/cni/bin/* /host/opt/cni/bin/;
#              while true; do sleep 3600; done;
#          volumeMounts:
#            - name: cni-bin
#              mountPath: /host/opt/cni/bin/
#        - name: kubelet
#          image: ${HYPERKUBE}
#          command:
#            - /nsenter
#            - --mount
#            - --target=1
#            - --wd=.
#            - --
#            - ./hyperkube
#            - kubelet
#            - --cloud-provider=
#            - --node-labels=role=controller
#            - --register-schedulable=false
#            - --lock-file=/var/run/kubelet/lock
#            - --require-kubeconfig
#            - --kubeconfig=/var/lib/kubelet/kubeconfig
#            - --pod-manifest-path=/etc/kubernetes/manifests
#            - --allow-privileged=true
#            - --cluster-dns=10.0.0.10
#            - --cluster-domain=cluster.local
#            - --network-plugin=cni
#            - --network-plugin-dir=/etc/cni/net.d
#            - --tls-cert-file=/etc/kubelet/cert.pem
#            - --tls-private-key-file=/etc/kubelet/key.pem
#            - --hairpin-mode=hairpin-veth
#          securityContext:
#            privileged: true
#          env:
#            - name: PATH
#              value: /usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/opt/bin
      volumes:
        - name: etc-kubelet
          hostPath:
            path: /etc/kubelet/
        - name: var-lib-vault
          hostPath:
            path: /var/lib/vault/
        - name: cni-bin
          hostPath:
            path: /opt/cni/bin/
        - name: opt-bin
          hostPath:
            path: /opt/bin/
