kind: DaemonSet
apiVersion: extensions/v1beta1
metadata:
  name: kubelet-worker
  namespace: kube-system
  labels:
    app: kubelet
    role: worker
spec:
  template:
    metadata:
      labels:
        app: kubelet
        role: worker
    spec:
      nodeSelector:
        role: worker
      hostPID: true
      hostNetwork: true
      containers:
        - name: vault-certs
          image: quay.io/roboll/vault-cert-sidecar:v0.0.1-6-g0c646b8
          args:
            - -auth-strategy=token-file
            - -pki-backend=${KUBE_PKI_MOUNT}
            - -auth-dir=/var/lib/vault/
            - -cert-dir=/etc/kubelet/
            - -hostname=kubelet
          env:
            - name: VAULT_ADDR
              value: ${VAULT_ADDR}
          volumeMounts:
            - name: etc-kubelet
              mountPath: /etc/kubelet/
            - name: var-lib-vault
              mountPath: /var/lib/vault/
        - name: host-bin
          image: ${HYPERKUBE}
          command:
            - /bin/sh
            - -c
            - cp -r /opt/cni/bin/* /host/opt/cni/bin/;
              cp /usr/bin/socat /opt/bin/;
              while true; do sleep 3600; done;
          volumeMounts:
            - name: cni-bin
              mountPath: /host/opt/cni/bin/
            - name: opt-bin
              mountPath: /opt/bin/
        - name: kubelet
          image: ${HYPERKUBE}
          command:
            - /nsenter
            - --mount
            - --target=1
            - --wd=.
            - --
            - ./hyperkube
            - kubelet
            - --cloud-provider=aws
            - --node-labels=role=worker
            - --lock-file=/var/run/kubelet/lock
            - --require-kubeconfig
            - --kubeconfig=/var/lib/kubelet/kubeconfig
            - --allow-privileged=true
            - --cluster-dns=10.0.0.10
            - --cluster-domain=cluster.local
            - --network-plugin=cni
            - --network-plugin-dir=/etc/cni/net.d
            - --tls-cert-file=/etc/kubelet/cert.pem
            - --tls-private-key-file=/etc/kubelet/key.pem
            - --hairpin-mode=hairpin-veth
          securityContext:
            privileged: true
      volumes:
        - name: etc-kubelet
          hostPath:
            path: /etc/kubelet/
        - name: var-lib-vault
          hostPath:
            path: /var/lib/vault/
        - name: cni-bin
          hostPath:
            path: /opt/cni/bin/
        - name: opt-bin
          hostPath:
            path: /opt/bin/
