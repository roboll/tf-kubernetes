kind: DaemonSet
apiVersion: extensions/v1beta1
metadata:
  name: etcd
  namespace: kube-system
  labels:
    app: etcd
spec:
  template:
    metadata:
      labels:
        app: etcd
    spec:
      nodeSelector:
        role: controller
      hostNetwork: true
      containers:
        - name: etcd
          image: quay.io/coreos/etcd:v3.0.12
          command:
            - /bin/sh
            - -c
            - exec /usr/local/bin/etcd
                --name=$(hostname -s)
                --advertise-client-urls=https://$(hostname -f):2379
                --initial-advertise-peer-urls=https://$(hostname -f):2380
          env:
            - name: ETCD_INITIAL_CLUSTER
              value: ${ETCD_PEERS}
            - name: ETCD_DATA_DIR
              value: /var/lib/etcd/data
            - name: ETCD_INITIAL_CLUSTER_STATE
              value: new
            - name: ETCD_LISTEN_CLIENT_URLS
              value: https://0.0.0.0:2379
            - name: ETCD_LISTEN_PEER_URLS
              value: https://0.0.0.0:2380
            - name: ETCD_CERT_FILE
              value: /etc/secrets/cert.pem
            - name: ETCD_KEY_FILE
              value: /etc/secrets/key.pem
            - name: ETCD_TRUSTED_CA_FILE
              value: /etc/secrets/ca.pem
            - name: ETCD_CLIENT_CERT_AUTH
              value: "true"
            - name: ETCD_PEER_CERT_FILE
              value: /etc/secrets/cert.pem
            - name: ETCD_PEER_KEY_FILE
              value: /etc/secrets/key.pem
            - name: ETCD_PEER_TRUSTED_CA_FILE
              value: /etc/secrets/ca.pem
            - name: ETCD_PEER_CLIENT_CERT_AUTH
              value: "true"
          volumeMounts:
            - name: data
              mountPath: /var/lib/etcd/
            - name: secrets
              mountPath: /etc/secrets/
              readOnly: true
          resources:
            requests:
              cpu: 500m
              memory: 512Mi
            limits:
              cpu: 1000m
              memory: 512Mi
        - name: metrics-proxy
          image: quay.io/roboll/etcd-metrics-proxy:v0.5
          args:
            - --upstream-server-name=localhost
            - --etcd-ca=/etc/secrets/ca.pem
            - --etcd-cert=/etc/secrets/cert.pem
            - --etcd-key=/etc/secrets/key.pem
          volumeMounts:
            - name: secrets
              mountPath: /etc/secrets/
              readOnly: true
          resources:
            requests:
              cpu: 5m
              memory: 64Mi
            limits:
              cpu: 5m
              memory: 64Mi
        - name: vault-cert-sidecar
          image: quay.io/roboll/vault-cert-sidecar:v0.0.1-6-g0c646b8
          args:
            - -auth-strategy=token-file
            - -pki-backend=${ETCD_PKI_MOUNT}
            - -pki-role=etcd
            - -cert-dir=/etc/secrets
            - -auth-dir=/var/lib/vault
            - -san=localhost
          env:
            - name: VAULT_ADDR
              value: ${VAULT_ADDR}
          volumeMounts:
            - name: vault-secrets
              mountPath: /var/lib/vault/
              readOnly: true
            - name: secrets
              mountPath: /etc/secrets/
          resources:
            requests:
              cpu: 5m
              memory: 16Mi
            limits:
              cpu: 5m
              memory: 16Mi
        - name: watcher
          image: quay.io/roboll/watcher:v0.1.0
          args:
            - -watch=/etc/secrets/
            - -exec-command=kubectl -n $(POD_NAMESPACE) exec $(POD_NAME) -c etcd -- pkill -HUP etcd
          volumeMounts:
            - name: secrets
              mountPath: /etc/secrets/cert.pem
              readOnly: true
          env:
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
            - name: POD_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
      volumes:
        - name: secrets
          emptyDir: {}
        - name: data
          hostPath:
            path: /var/lib/etcd/
        - name: vault-secrets
          hostPath:
            path: /var/lib/vault/
