apiVersion: v1
kind: Pod
metadata:
  name: bootstrap-etcd
  namespace: kube-system
  labels:
    app: bootstrap-kubernetes
    component: etcd
spec:
  hostNetwork: true
  containers:
    - name: vault-sidekick
      image: quay.io/roboll/vault-sidekick:v0.0.9.12
      args:
        - -logtostderr=true
        - -output=/etc/secrets
        - -ca-cert=/etc/ssl/vault/ca.pem
        - -cn=pki:${ETCD_PKI_MOUNT}/issue/etcd:common_name=etcd,alt_names=localhost,file=etcd,fmt=cert
      env:
        - name: VAULT_ADDR
          value: ${VAULT_ADDR}
        - name: VAULT_SIDEKICK_TOKEN_FILE
          value: /var/lib/vault/token
      volumeMounts:
        - name: secrets
          mountPath: /etc/secrets
        - name: vault-ca
          mountPath: /etc/ssl/vault/ca.pem
          readOnly: true
        - name: vault-token
          mountPath: /var/lib/vault/token
          readOnly: true
    - name: etcd
      image: quay.io/coreos/etcd:v3.0.12
      command:
        - /bin/sh
        - -c
        - exec /usr/local/bin/etcd
            --name=$(hostname -s)
            --advertise-client-urls=https://$(hostname -f):2379
            --initial-advertise-peer-urls=https://$(hostname -f):2380
      env:
        - name: ETCD_INITIAL_CLUSTER
          value: ${ETCD_PEERS}
        - name: ETCD_DATA_DIR
          value: /var/lib/etcd/data
        - name: ETCD_INITIAL_CLUSTER_STATE
          value: new
        - name: ETCD_LISTEN_CLIENT_URLS
          value: https://0.0.0.0:2379
        - name: ETCD_LISTEN_PEER_URLS
          value: https://0.0.0.0:2380
        - name: ETCD_CERT_FILE
          value: /etc/secrets/etcd.crt
        - name: ETCD_KEY_FILE
          value: /etc/secrets/etcd.key
        - name: ETCD_TRUSTED_CA_FILE
          value: /etc/secrets/etcd.ca
        - name: ETCD_CLIENT_CERT_AUTH
          value: "true"
        - name: ETCD_PEER_CERT_FILE
          value: /etc/secrets/etcd.crt
        - name: ETCD_PEER_KEY_FILE
          value: /etc/secrets/etcd.key
        - name: ETCD_PEER_TRUSTED_CA_FILE
          value: /etc/secrets/etcd.ca
        - name: ETCD_PEER_CLIENT_CERT_AUTH
          value: "true"
      volumeMounts:
        - name: data
          mountPath: /var/lib/etcd
        - name: secrets
          mountPath: /etc/secrets
          readOnly: true
  volumes:
    - name: data
      hostPath:
        path: /var/lib/etcd
    - name: vault-ca
      hostPath:
        path: /etc/ssl/vault/ca.pem
    - name: vault-token
      hostPath:
        path: /var/lib/vault/token
    - name: secrets
      emptyDir: {}
