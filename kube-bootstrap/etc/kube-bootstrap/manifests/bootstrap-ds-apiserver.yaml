apiVersion: v1
kind: Pod
metadata:
  name: bootstrap-apiserver
  namespace: kube-system
  labels:
    app: bootstrap-kubernetes
    component: apiserver
spec:
  hostNetwork: true
  containers:
    - name: vault-cert-sidecar
      image: quay.io/roboll/vault-cert-sidecar:v0.0.1-6-g0c646b8
      args:
        - -auth-strategy=token-file
        - -pki-backend=${ETCD_PKI_MOUNT}
        - -cert-dir=/var/lib/secrets
        - -auth-dir=/var/lib/vault
      env:
        - name: VAULT_ADDR
          value: ${VAULT_ADDR}
      volumeMounts:
        - name: vault-secrets
          mountPath: /var/lib/vault/
        - name: secrets
          mountPath: /var/lib/secrets/
    - name: apiserver
      image: ${HYPERKUBE}
      command:
        - /bin/sh
        - -c
        - echo "bootstrap,bootstrap,bootstrap" > /etc/kubernetes/bootstrap-auth;
          exec /apiserver
            --secure-port=443
            --bind-address=127.0.0.1
            --allow-privileged=true
            --runtime-config=api/all=true
            --authorization-mode=RBAC
            --authorization-rbac-super-user=bootstrap
            --token-auth-file=/etc/kubernetes/bootstrap-auth
            --service-cluster-ip-range=10.0.0.0/16
            --etcd-servers=https://localhost:2379
            --etcd-cafile=/var/lib/secrets/ca.pem
            --etcd-certfile=/var/lib/secrets/cert.pem
            --etcd-keyfile=/var/lib/secrets/key.pem
            --admission-control=NamespaceLifecycle,LimitRanger,ServiceAccount,ResourceQuota,DenyEscalatingExec,ServiceAccount
      volumeMounts:
        - name: secrets
          mountPath: /var/lib/secrets
          readOnly: true
  volumes:
    - name: secrets
      emptyDir: {}
    - name: vault-secrets
      hostPath:
        path: /var/lib/vault/
