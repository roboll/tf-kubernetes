apiVersion: v1
kind: Pod
metadata:
  name: bootstrap-apiserver
  namespace: kube-system
  labels:
    app: bootstrap-kubernetes
    component: apiserver
spec:
  hostNetwork: true
  containers:
    - name: vault-sidekick
      image: quay.io/roboll/vault-sidekick:v0.0.9.12
      args:
        - -logtostderr=true
        - -output=/etc/secrets
        - -ca-cert=/etc/ssl/vault/ca.pem
        - -cn=pki:${ETCD_PKI_MOUNT}/issue/apiserver:common_name=controller,file=etcd,fmt=cert
      env:
        - name: VAULT_ADDR
          value: ${VAULT_ADDR}
        - name: VAULT_SIDEKICK_TOKEN_FILE
          value: /var/lib/vault/token
      volumeMounts:
        - name: secrets
          mountPath: /etc/secrets
        - name: vault-ca
          mountPath: /etc/ssl/vault/ca.pem
          readOnly: true
        - name: vault-token
          mountPath: /var/lib/vault/token
          readOnly: true
    - name: apiserver
      image: ${HYPERKUBE}
      command:
        - /bin/sh
        - -c
        - echo "bootstrap,bootstrap,bootstrap" > /etc/kubernetes/bootstrap-auth;
          exec /apiserver
            --secure-port=443
            --bind-address=127.0.0.1
            --allow-privileged=true
            --runtime-config=api/all=true
            --authorization-mode=RBAC
            --authorization-rbac-super-user=bootstrap
            --token-auth-file=/etc/kubernetes/bootstrap-auth
            --service-cluster-ip-range=10.0.0.0/16
            --external-hostname=${KUBE_FQDN}
            --etcd-servers=localhost:2379
            --etcd-cafile=/etc/secrets/etcd.ca
            --etcd-certfile=/etc/secrets/etcd.crt
            --etcd-keyfile=/etc/secrets/etcd.key
            --admission-control=NamespaceLifecycle,LimitRanger,ServiceAccount,ResourceQuota,DenyEscalatingExec,ServiceAccount
      volumeMounts:
        - name: secrets
          mountPath: /etc/secrets
          readOnly: true
  volumes:
    - name: secrets
      emptyDir: {}
    - name: vault-ca
      hostPath:
        path: /etc/ssl/vault/ca.pem
    - name: vault-token
      hostPath:
        path: /var/lib/vault/token
